<!DOCTYPE html>
<html lang="en" xmlns:th="https://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
    layout:decorate="~{layout-dashboard}">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title th:text="${titulo}"></title>
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1"></script>

    <style>
        body {
            background: #f7f8fb;
        }

        .section-title {
            margin: 24px 0 12px;
        }

        .kpi-card {
            transition: transform .15s ease, box-shadow .15s;
        }

        .kpi-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 24px rgba(0, 0, 0, .08);
        }

        .chart-container {
            position: relative;
            margin: 16px auto;
            max-width: 900px;
        }

        canvas {
            width: 100% !important;
            height: auto !important;
        }

        .table thead th {
            background: #f1f3f8;
        }

        .btn-ghost {
            background: #fff;
            border: 1px solid #e5e7eb;
        }

        .container {
            margin-left: 20px;
        }
    </style>
</head>

<body>
    <div layout:fragment="dashboard"> <!--Toda la información va adentro de este div, no afuera -->

        <div class="container py-4">
            <div class="row g-3">
                <div class="col-md-4">
                    <div class="card kpi-card border-0 shadow-sm">
                        <div class="card-body border border-primary">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <div class="text-muted small">Total vendido</div>
                                    <div class="fs-3 fw-bold" th:text="'$' + ${#numbers.formatDecimal(ganNeta, 1, 2)}">
                                    </div>
                                </div>
                                <!-- <span class="badge text-bg-success">+5.3%</span> -->
                            </div>
                            <div class="text-muted small mt-2">Todas las ventas</div>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card kpi-card border-0 shadow-sm">
                        <div class="card-body border border-primary">
                            <div class="text-muted small">Tickets</div>
                            <div class="fs-3 fw-bold" th:text="${totalVentas}"></div>
                            <div class="text-muted small mt-2">Cantidad de ventas</div>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card kpi-card border-1 shadow-sm">
                        <div class="card-body border border-primary">
                            <div class="text-muted small">Ticket promedio</div>
                            <div class="fs-3 fw-bold" th:text="'$' + ${#numbers.formatDecimal(averTicket, 1, 2)}"></div>
                            <div class="text-muted small mt-2">Total / Tickets</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Gráficos fila 1 -->
            <h5 class="section-title">Ventas</h5>
            <div class="row g-4">
                <div class="col-lg-8">
                    <div class="card border-0 shadow-sm">
                        <div class="card-header bg-white">
                            <div class="d-flex justify-content-between align-items-center">
                                <span class="fw-semibold">Ventas diarias</span>
                                <button id="dlVentas" class="btn btn-sm btn-ghost">Descargar PNG</button>
                            </div>
                        </div>
                        <div class="card-body">
                            <div class="chart-container">
                                <canvas id="ventasDiarias"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-lg-4">
                    <div class="card border-0 shadow-sm">
                        <div class="card-header bg-white">
                            <div class="d-flex justify-content-between align-items-center">
                                <span class="fw-semibold">Método de pago</span>
                                <button id="dlPago" class="btn btn-sm btn-ghost">Descargar PNG</button>
                            </div>
                        </div>
                        <div class="card-body">
                            <div class="chart-container" style="max-width: 380px;">
                                <canvas id="metodoPago"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Gráficos fila 2 -->
            <h5 class="section-title">Rendimiento de productos</h5>
            <div class="row g-4">
                <!-- <div class="col-lg-6">
                    <div class="card border-0 shadow-sm">
                        <div class="card-header bg-white d-flex justify-content-between align-items-center">
                            <span class="fw-semibold">Top 10 productos (unidades)</span>
                            <button id="dlTopProd" class="btn btn-sm btn-ghost">Descargar PNG</button>
                        </div>
                        <div class="card-body">
                            <div class="chart-container">
                                <canvas id="topProductos"></canvas>
                            </div>
                        </div>
                    </div>
                </div> -->
                <div class="col-lg-6">
                    <div class="card border-0 shadow-sm">
                        <div class="card-header bg-white d-flex justify-content-between align-items-center">
                            <span class="fw-semibold">Stock crítico</span>
                            <button id="csvStock" class="btn btn-sm btn-ghost">Exportar CSV</button>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table id="tblStock" class="table table-hover align-middle">
                                    <thead>
                                        <tr>
                                            <th>Producto</th>
                                            <th>Stock</th>
                                            <th>Mínimo</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr th:each="p : ${bajoStock}">
                                            <td th:text="${p.nombre}"></td>
                                            <td th:text="${p.stock}"></td>
                                            <td th:text="${p.stockMin}"></td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                            <!-- <small class="text-muted">*Datos demo: reemplazar con tu consulta de inventario.</small> -->
                        </div>
                    </div>
                </div>
                <div class="col-lg-6">
                    <div class="card border-0 shadow-sm">
                        <div class="card-header bg-white d-flex justify-content-between align-items-center">
                            <span class="fw-semibold">Top 10 categorías (importe)</span>
                            <button id="dlCategorias" class="btn btn-sm btn-ghost">Descargar PNG</button>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-hover align-middle">
                                    <thead>
                                        <tr>
                                            <th>#</th>
                                            <th>Categoria</th>
                                            <th>Importe Total ($)</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr th:each="categoria, iterStat : ${top10Categorias}">
                                            <td th:text="${iterStat.index + 1}"></td>
                                            <td th:text="${categoria.nombre}"></td>
                                            <!-- <td
                                                td:text="${#numbers.formatDecimal(categoria.total, 1, 'COMMA', 2, 'POINT')}">
                                            </td> -->
                                            <td th:text="'$'+${categoria.total}"></td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Tablas -->
            <h5 class="section-title">Tablas</h5>
            <div class="row g-4">
                <div class="col-lg-7">
                    <div class="card border-0 shadow-sm">
                        <div class="card-header bg-white d-flex justify-content-between align-items-center">
                            <span class="fw-semibold">Productos más vendidos</span>
                            <button id="csvTop" class="btn btn-sm btn-ghost">Exportar CSV</button>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table id="tblTop" class="table table-hover align-middle">
                                    <thead>
                                        <tr>
                                            <th>#</th>
                                            <th>Producto</th>
                                            <th>Unidades</th>
                                            <th>Importe</th>
                                        </tr>
                                    </thead>
                                    <tbody><!-- se llena por JS --></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

        </div>

        <!-- Top productos vendidos -->
        <div id="topProductosData" th:attr="data-top=${topProductos}"></div>

        <!-- Ventas por dia en un rango de 10 dias -->
        <div id="ventasDiariasData" th:attr="data-labels=${labels}, data-data=${data}"></div>

        <!-- Metodos de pago por importe -->
        <div id="metodoPagoData" th:attr="data-metodo-pago=${metodoPago}"></div>
        
    </div>
    <!-- Mis JS -->
    <script th:fragment="js" th:src="@{/js/reportes.js}"></script>
</body>

</html>